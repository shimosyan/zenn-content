---
title: "標準ユーザーに対して Microsoft Intune と Winget を組み合わせアプリケーション配布を実現させたい"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Intune", "PowerShell", "Windows", "Winget"]
published: true
---

## はじめに注意点

:::message
Intune と Winget を組み合わせてアプリケーションを配布する方法は、Winget プロジェクトでも議論の最中にあり今後仕様が変わる可能性があります。

また独自調査のため誤った説明が入っている可能性があります。
:::

## これは何？

Intune で Windows 端末に対してアプリケーションを配布する作業、とてもめんどくさいです。

https://zenn.dev/shimosyan/articles/2f34f66d1d5b9a

こちらの記事でも書いたとおり、ある程度共通化・簡略化をしてアプリケーションを配布を実現したいです。
その方法の一つとして Microsoft 公式のパッケージマネージャーである Winget と組み合わせる方法があります。

## 既知の課題

Intune + Winget を使う方法を調べると、「**システム**ではなく**ユーザー**を指定すること」と記載があります。

これは「Winget がユーザーコンテキストにしか対応していないため」ということが主な理由として説明されています。

Intune では「**システム**を指定するとWindowsのSystemアカウントの資格情報（システムコンテキスト）」、「**ユーザー**を指定するとログインしているユーザーの資格情報（ユーザーコンテキスト）」で処理が動きます。

ログインユーザーの資格情報で処理されるということは、つまりユーザーに管理者特権が付与されている必要があります。逆に特権を持たない標準ユーザーでは実行すると UAC に阻まれてしまうわけです。

## 今回の課題

標準ユーザーしかない端末に対して Intune を使ってアプリケーションをインストールさせたいとき、Winget を使う方法だと UAC で止められてしまう事象が発生しました。

ユーザーは UAC の認証ができないため、インストールが成功しない事態になります。

## Winget をシステムコンテキストで実行させるには

標準ユーザーでログインしている端末ではユーザーコンテキストでは管理特権を行使することができません。必然的にシステムコンテキストで実行させるしかなくなります。

`winget install --id **.**` のような一般的なコマンドのまま Intune の配布設定をユーザーからシステムに作り直しても、結果が変わりません。

しかし、いろいろ文献を調べてみると Winget の実行バイナリは2種類あることがわかってきました。

一つ目は `winget` コマンドの PATH 先となっている`%LOCALAPPDATA%\Microsoft\WindowsApps\winget.exe` です。<!-- cspell:disable-line -->

もう一つは `C:\Program FIles\WindowsApps\Microsoft.DesktopAppInstaller_**_x64__8wekyb3d8bbwe\winget.exe` です。(`**` には Winget のバージョンが入ります)<!-- cspell:disable-line -->

さらに調べてみると、前者はユーザーコンテキストで、後者はシステムコンテキストで動作できることがわかってきました。

つまり、今回のケースでは後者の Winget を使うことで解決できるということがわかりました。

## 実装からの動作確認について

~~書くのが大変なので~~今回は割愛しますが、私のところではシステムコンテキストかユーザーコンテキストかどちらで実行されているかを判定して、それにあわせたバイナリを選択してコマンドを実行するスクリプトを書きました。今のところ問題なく動いています。

Intune の検出ルールで Winget コマンドを使う際は、こちらもコンテキストごとに Winget のバイナリを切り替える実装をする必要があることだけ注意が必要です。

## 最後に

というわけで、Intune と Winget を組み合わせて標準ユーザーの Windows 端末に対してアプリケーションの配布を実現するための解決策を紹介しました。

記載した内容について何かありましたら記事コメントか X/Twitter までご連絡ください。
